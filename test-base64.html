<!DOCTYPE html>
<html>
<head>
    <title>Test Base64 Image</title>
</head>
<body>
    <h1>Test Base64 Image Generation</h1>
    <input type="file" id="fileInput" accept="image/*">
    <div id="result"></div>
    <div id="preview"></div>

    <script>
        function compressAndConvertToBase64(file) {
            return new Promise((resolve, reject) => {
                console.log('Starting image compression for:', file.name, file.size);
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    try {
                        console.log('Image loaded, original dimensions:', img.width, 'x', img.height);
                        
                        // Calculate new dimensions (max 800px width, maintain aspect ratio)
                        const maxWidth = 800;
                        const maxHeight = 600;
                        let { width, height } = img;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                        
                        console.log('Compressed dimensions:', width, 'x', height);
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw and compress
                        if (ctx) {
                            ctx.drawImage(img, 0, 0, width, height);
                            const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8); // 80% quality
                            
                            console.log('Compression complete:', {
                                original: file.size,
                                compressed: compressedDataUrl.length,
                                ratio: (compressedDataUrl.length / file.size * 100).toFixed(1) + '%',
                                startsWithData: compressedDataUrl.startsWith('data:')
                            });
                            
                            resolve(compressedDataUrl);
                        } else {
                            reject(new Error('Canvas context not available'));
                        }
                    } catch (error) {
                        console.error('Error compressing image:', error);
                        reject(error);
                    }
                };
                
                img.onerror = (error) => {
                    console.error('Failed to load image for compression:', error);
                    reject(new Error('Failed to load image for compression'));
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const result = await compressAndConvertToBase64(file);
                
                document.getElementById('result').innerHTML = `
                    <h3>Result:</h3>
                    <p>URL Length: ${result.length}</p>
                    <p>Starts with data: ${result.startsWith('data:') ? 'Yes' : 'No'}</p>
                    <p>First 100 chars: ${result.substring(0, 100)}...</p>
                `;
                
                document.getElementById('preview').innerHTML = `
                    <h3>Preview:</h3>
                    <img src="${result}" style="max-width: 400px; max-height: 300px; border: 1px solid #ccc;">
                `;
            } catch (error) {
                document.getElementById('result').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
